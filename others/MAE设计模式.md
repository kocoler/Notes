MAE 设计模式重构与修改
===

### 基本情况

- 项目功能：MAE(MUXI APP ENGINE)主要提供学校木犀团队的基础建设平台后端服务。
- 使用场景：PASS，提供与团队 k8s 集群的交互，屏蔽底层细节，方便开发者 部署/回滚 等操作。同时提供相关服务器等监控服务。
- 代码行数

  经过 `git ls-files` 统计(去除 .gitignore 的文件)，后端部分代码行数大约 2w 行
  ![图 11](https://s2.loli.net/2022/01/04/mB9Qka3sodrAVKn.png)  

### 使用的设计模式

#### 1. 单例模式

- 解决问题

  对于所有管理的集群，每个集群都要和 k8s 集群建立连接，因为设计上就是通过与集群的 `api-server` 交互来管理集群。
  所有每个集群实例都需要相关一系列的初始化，比较复杂，并且只需要初始化一次，
  这样，就可以通过单例模式来使每个实例的数量只有一个，并且都是同一个，而且在同一个地方管理

- UML 类图

  ![图 12](https://s2.loli.net/2022/01/04/ITSbBsfdVANZv1y.png)  

- UML 类图含义

  图中，`ClusterSingleton` 负责管理所有初始化好的实例，`Client` 通过 `GetInstance` 获取具体的 `Cluster` 的实例。


#### 2. 代理模式

- 解决问题

  通过代理模式来进行与集群的统一交互，可以缓存集群信息，集群状态等，不需要每次操作重新像集群建立连接，开始请求，节约了资源。
  并且可以将操作统一在一起。判断具体哪个操作需要继续执行，减少不必要的操作。
  统一记录日志。

- UML 类图

  ![图 13](https://s2.loli.net/2022/01/04/TcAtzbMFql5HkmQ.png)  

- UML 类图含义

  图中，`ClusterProxy` 负责管理所有初始化好的实例，客户端都通过 `Proxy` 与 `K8sClientSet` 交互，也就是说 `Proxy` 代理了客户端与 k8s 服务端见的所有请求，可以做一些统一的管理、状态维护、日志、缓存等等。


#### 3. 适配器模式

- 解决问题
  
  MAE 需要与多种外部服务交互，比如 OAuth 服务，CI pipeline 服务，ECS 服务等等，而服务的每个供应商都是不同的，于是我们引入适配器模式，屏蔽里面的复杂操作，解决各个供应商 API 不统一的问题。

- UML 类图
  
  以 Aliyun ECS 为例
  ![图 14](https://s2.loli.net/2022/01/04/jq1bSay84GlhVUF.png)  

- UML 类图含义
  
  图中，`AliyunECSAdapter` 是一个适配器，它负责将阿里云 `ECS` 的 API 转换成 `MAE` 中符合 `ECS interface` 规定的 API。
  类似的，其他服务、服务商，也都可以通过类似的方法，接入到 `MAE` 中。


#### 4. 策略模式
- 解决问题
  
  K8s 具有非常多种类型的资源，而他们大部分的处理流程都是相似的，于是，我们把各自独有并且复杂的算法，放到不同类的实现中，具体处理函数可以使用各种不同的算法变体，并能在运行时切换算法。

- UML 类图
  ![图 15](https://s2.loli.net/2022/01/04/eGbISjgJyrkYU1H.png)  

- UML 类图含义
  
  图中 `DeployContext` 为具体的部署上下文，客户端需要将符合 `DeployCallback` 规定的具体 `callback` 策略传入到其中，然后 `DeployContext` 会在相应的部分调用 `callback` 的相应方法。
